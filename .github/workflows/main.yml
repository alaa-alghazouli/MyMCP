name: Build & Create DMG (Final)
on: workflow_dispatch

jobs:
  build_and_package:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # STEP 1: Build the App (Fixing Exit Code 65 & Path)
      # ---------------------------------------------------------
      - name: Build App (Ad-Hoc Signed)
        run: |
          # Go into the subfolder
          cd MyMCP
          
          # Build with fake "Ad-Hoc" signature so it doesn't crash
          xcodebuild -scheme MyMCP \
            -configuration Release \
            -derivedDataPath build \
            MACOSX_DEPLOYMENT_TARGET=13.0 \
            ARCHS="x86_64 arm64" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED="NO" \
            CODE_SIGNING_ALLOWED="YES" \
            CODE_SIGN_STYLE="Manual"

      # ---------------------------------------------------------
      # STEP 2: Create DMG using sindresorhus/create-dmg
      # ---------------------------------------------------------
      - name: Package into DMG
        run: |
          # Go to the folder where the app was built
          cd MyMCP/build/Build/Products/Release
          
          # Create the DMG (using npx)
          npx create-dmg MyMCP.app --overwrite || true
          
          # Rename for clarity
          mv *.dmg MyMCP_Installer.dmg

      # ---------------------------------------------------------
      # STEP 3: Upload the DMG
      # ---------------------------------------------------------
      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: MyMCP-Installer
          path: MyMCP/build/Build/Products/Release/MyMCP_Installer.dmg
