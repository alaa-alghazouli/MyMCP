name: Build (Nuclear Fix)
on: workflow_dispatch

jobs:
  build_and_package:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build App (Security Disabled)
        run: |
          cd MyMCP
          
          # We add ENABLE_HARDENED_RUNTIME=NO and CODE_SIGN_ENTITLEMENTS="" 
          # This strips the security requirements that are causing the crash.
          xcodebuild -scheme MyMCP \
            -configuration Release \
            -derivedDataPath build \
            MACOSX_DEPLOYMENT_TARGET=13.0 \
            ARCHS="x86_64 arm64" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED="NO" \
            CODE_SIGNING_ALLOWED="YES" \
            CODE_SIGN_STYLE="Manual" \
            ENABLE_HARDENED_RUNTIME=NO \
            CODE_SIGN_ENTITLEMENTS=""

      - name: Verify App Exists
        # Sometimes Xcode says "Fail" (65) but the App is actually there.
        # This step checks if we succeeded despite the error.
        run: |
          if [ -d "MyMCP/build/Build/Products/Release/MyMCP.app" ]; then
            echo "✅ APP FOUND! Proceeding to package..."
          else
            echo "❌ BUILD TRULY FAILED."
            exit 1
          fi

      - name: Package into DMG
        run: |
          cd MyMCP/build/Build/Products/Release
          npx create-dmg MyMCP.app --overwrite || true
          mv *.dmg MyMCP_Installer.dmg

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: MyMCP-Installer
          path: MyMCP/build/Build/Products/Release/MyMCP_Installer.dmg
