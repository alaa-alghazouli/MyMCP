name: Build Fix (Skip Sentry)
on: workflow_dispatch

jobs:
  build_and_package:
    runs-on: macos-14
    
    # 1. GLOBAL FIX: Tell Sentry to stop trying to upload
    env:
      SENTRY_DISABLE_AUTO_UPLOAD: true
      SENTRY_NO_PROGRESS_BAR: true

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build App
        run: |
          cd MyMCP
          
          # Clean any weird file attributes that confuse the signer
          xattr -cr .

          # Build with Sentry Upload Disabled
          xcodebuild -scheme MyMCP \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED="NO" \
            CODE_SIGNING_ALLOWED="YES" \
            CODE_SIGN_STYLE="Manual"

      - name: Package into DMG
        run: |
          cd MyMCP/build/Build/Products/Release
          npx create-dmg MyMCP.app --overwrite || true
          mv *.dmg MyMCP_Installer.dmg

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: MyMCP-Installer
          path: MyMCP/build/Build/Products/Release/MyMCP_Installer.dmg
