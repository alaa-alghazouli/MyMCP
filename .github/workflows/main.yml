name: FINAL FIX (Ad-Hoc Signing)
on: workflow_dispatch

jobs:
  build:
    name: Build with Ad-Hoc Sign
    runs-on: macos-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build App (Ad-Hoc Signed)
        run: |
          # 1. Enter the project folder
          cd MyMCP
          
          # 2. Build with Ad-Hoc Signing ("-")
          # This fixes the "Exit Code 65" by satisfying the Apple Silicon requirement
          xcodebuild -scheme MyMCP \
            -configuration Release \
            -derivedDataPath build \
            MACOSX_DEPLOYMENT_TARGET=13.0 \
            ARCHS="x86_64 arm64" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED="NO" \
            CODE_SIGNING_ALLOWED="YES"

      - name: Zip with Symlinks
        run: |
          # Go to the specific build output folder
          cd MyMCP/build/Build/Products/Release
          
          # Zip it properly to prevent "Damaged App" error
          zip -r -y MyMCP_AdHoc.zip MyMCP.app

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: MyMCP-App-Fixed
          path: MyMCP/build/Build/Products/Release/MyMCP_AdHoc.zip
