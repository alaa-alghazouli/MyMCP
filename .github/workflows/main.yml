name: Build MyMCP (Universal Intel Fix)
on: workflow_dispatch

jobs:
  build_and_package:
    # We use macos-15 because the project requires Xcode 16
    runs-on: macos-15
    
    env:
      SENTRY_DISABLE_AUTO_UPLOAD: true
      SENTRY_NO_PROGRESS_BAR: true

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Universal App (Intel + Apple Silicon)
        run: |
          cd MyMCP
          xattr -cr .

          # CRITICAL FIXES FOR INTEL MACS:
          # 1. ARCHS="x86_64 arm64" -> Includes both Intel and M1/M2 code
          # 2. ONLY_ACTIVE_ARCH=NO  -> Prevents it from skipping Intel
          xcodebuild -scheme MyMCP \
            -configuration Release \
            -derivedDataPath build \
            ARCHS="x86_64 arm64" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED="NO" \
            CODE_SIGNING_ALLOWED="YES" \
            CODE_SIGN_STYLE="Manual"

      - name: Package into DMG
        run: |
          cd MyMCP/build/Build/Products/Release
          
          # Create DMG
          npx create-dmg MyMCP.app --overwrite || true
          mv *.dmg MyMCP_Universal_Installer.dmg

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: MyMCP-Universal-Installer
          path: MyMCP/build/Build/Products/Release/MyMCP_Universal_Installer.dmg
